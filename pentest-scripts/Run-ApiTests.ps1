# PowerShell Script for API Penetration Testing
# Military Transition Application - Windows Compatible
#
# USAGE: .\Run-ApiTests.ps1 -AppUrl "https://military-transition.vercel.app" -JwtToken "eyJhbG..."
# REQUIREMENTS: PowerShell 5.1+ (built into Windows 10/11)

param(
    [Parameter(Mandatory=$true)]
    [string]$AppUrl,

    [Parameter(Mandatory=$true)]
    [string]$JwtToken
)

# Create results directory
$ResultsDir = "results"
if (!(Test-Path $ResultsDir)) {
    New-Item -ItemType Directory -Path $ResultsDir | Out-Null
}

$ResultsFile = "$ResultsDir\api-test-results-$(Get-Date -Format 'yyyyMMdd-HHmmss').txt"

# Helper functions
function Test-Passed {
    param([string]$Message)
    $output = "✅ PASS: $Message"
    Write-Host $output -ForegroundColor Green
    Add-Content -Path $ResultsFile -Value $output
}

function Test-Failed {
    param([string]$Message)
    $output = "❌ FAIL: $Message"
    Write-Host $output -ForegroundColor Red
    Add-Content -Path $ResultsFile -Value $output
}

function Test-Warning {
    param([string]$Message)
    $output = "⚠️  WARNING: $Message"
    Write-Host $output -ForegroundColor Yellow
    Add-Content -Path $ResultsFile -Value $output
}

function Test-Info {
    param([string]$Message)
    $output = "ℹ️  INFO: $Message"
    Write-Host $output -ForegroundColor Cyan
    Add-Content -Path $ResultsFile -Value $output
}

function Run-Test {
    param([string]$TestName)
    $separator = "========================================"
    Add-Content -Path $ResultsFile -Value "`n$separator"
    Add-Content -Path $ResultsFile -Value "TEST: $TestName"
    Add-Content -Path $ResultsFile -Value $separator
    Write-Host "`n$separator" -ForegroundColor Blue
    Write-Host "TEST: $TestName" -ForegroundColor Blue
    Write-Host $separator -ForegroundColor Blue
}

# Header
$header = @"
========================================
  API PENETRATION TEST - STARTED
========================================
Target: $AppUrl
Date: $(Get-Date)
JWT: $($JwtToken.Substring(0,20))...

"@
Write-Host $header
Add-Content -Path $ResultsFile -Value $header

###############################################################################
# TEST 1: Security Headers
###############################################################################

Run-Test "Security Headers Verification"

try {
    $response = Invoke-WebRequest -Uri $AppUrl -Method Head -UseBasicParsing

    $headers = $response.Headers
    Add-Content -Path $ResultsFile -Value ($headers | Out-String)

    # Check Content-Security-Policy
    if ($headers.'Content-Security-Policy') {
        Test-Passed "Content-Security-Policy header present"
    } else {
        Test-Failed "Content-Security-Policy header MISSING"
    }

    # Check X-Frame-Options
    if ($headers.'X-Frame-Options' -eq 'DENY') {
        Test-Passed "X-Frame-Options: DENY header present"
    } else {
        Test-Failed "X-Frame-Options header MISSING or not set to DENY"
    }

    # Check X-Content-Type-Options
    if ($headers.'X-Content-Type-Options' -eq 'nosniff') {
        Test-Passed "X-Content-Type-Options: nosniff header present"
    } else {
        Test-Failed "X-Content-Type-Options header MISSING"
    }

    # Check HSTS
    if ($headers.'Strict-Transport-Security') {
        Test-Passed "HSTS (Strict-Transport-Security) header present"
    } else {
        Test-Failed "HSTS header MISSING - HTTPS may not be enforced"
    }

    # Check Referrer-Policy
    if ($headers.'Referrer-Policy') {
        Test-Passed "Referrer-Policy header present"
    } else {
        Test-Warning "Referrer-Policy header MISSING"
    }
}
catch {
    Test-Failed "Failed to retrieve headers: $_"
}

###############################################################################
# TEST 2: HTTPS Enforcement
###############################################################################

Run-Test "HTTPS Enforcement"

$httpUrl = $AppUrl -replace 'https://', 'http://'
try {
    $response = Invoke-WebRequest -Uri $httpUrl -Method Head -UseBasicParsing -MaximumRedirection 0 -ErrorAction SilentlyContinue

    if ($response.StatusCode -in 301,302,308) {
        Test-Passed "HTTP redirects to HTTPS ($($response.StatusCode) found)"
    } else {
        Test-Warning "HTTP response: $($response.StatusCode)"
    }
}
catch {
    if ($_.Exception.Response.StatusCode -in 301,302,308) {
        Test-Passed "HTTP redirects to HTTPS"
    } else {
        Test-Info "HTTP test inconclusive: $_"
    }
}

###############################################################################
# TEST 3: CSRF Token Endpoint
###############################################################################

Run-Test "CSRF Token Endpoint"

try {
    $headers = @{
        "Authorization" = "Bearer $JwtToken"
    }

    $response = Invoke-RestMethod -Uri "$AppUrl/api/csrf-token" -Headers $headers
    Add-Content -Path $ResultsFile -Value "CSRF Response: $($response | ConvertTo-Json)"

    if ($response.csrfToken) {
        $csrfToken = $response.csrfToken
        Test-Passed "CSRF token endpoint returns valid token: $($csrfToken.Substring(0,20))..."

        if ($csrfToken.Length -gt 32) {
            Test-Passed "CSRF token length appropriate ($($csrfToken.Length) chars)"
        } else {
            Test-Warning "CSRF token seems short ($($csrfToken.Length) chars) - may be weak"
        }
    } else {
        Test-Failed "CSRF token endpoint not working or invalid response"
    }
}
catch {
    Test-Failed "CSRF token endpoint failed: $_"
    Add-Content -Path $ResultsFile -Value $_.Exception.Message
}

###############################################################################
# TEST 4: Authentication - Missing Token
###############################################################################

Run-Test "Authentication - Missing JWT Token"

try {
    $response = Invoke-WebRequest -Uri "$AppUrl/api/stripe/create-portal-session" `
        -Method Post `
        -ContentType "application/json" `
        -UseBasicParsing `
        -ErrorAction SilentlyContinue

    Test-Failed "Unauthorized request NOT rejected (got $($response.StatusCode) instead of 401/403)"
}
catch {
    $statusCode = $_.Exception.Response.StatusCode.value__
    Add-Content -Path $ResultsFile -Value "HTTP Code: $statusCode"

    if ($statusCode -in 401,403) {
        Test-Passed "Unauthorized request correctly rejected ($statusCode)"
    } else {
        Test-Failed "Unexpected status code: $statusCode"
    }
}

###############################################################################
# TEST 5: Authentication - Invalid Token
###############################################################################

Run-Test "Authentication - Invalid JWT Token"

try {
    $headers = @{
        "Authorization" = "Bearer invalid_token_12345"
        "Content-Type" = "application/json"
    }

    $response = Invoke-WebRequest -Uri "$AppUrl/api/stripe/create-portal-session" `
        -Method Post `
        -Headers $headers `
        -UseBasicParsing `
        -ErrorAction SilentlyContinue

    Test-Failed "Invalid token NOT rejected (got $($response.StatusCode))"
}
catch {
    $statusCode = $_.Exception.Response.StatusCode.value__
    Add-Content -Path $ResultsFile -Value "HTTP Code: $statusCode"

    if ($statusCode -in 401,403) {
        Test-Passed "Invalid token correctly rejected ($statusCode)"
    } else {
        Test-Warning "Unexpected status code: $statusCode"
    }
}

###############################################################################
# TEST 6: Price Manipulation
###############################################################################

Run-Test "Price Manipulation - Invalid Price ID"

try {
    $headers = @{
        "Authorization" = "Bearer $JwtToken"
        "Content-Type" = "application/json"
    }

    $body = @{
        priceId = "price_FAKE_FREE_TIER"
    } | ConvertTo-Json

    $response = Invoke-RestMethod -Uri "$AppUrl/api/stripe/create-checkout-session" `
        -Method Post `
        -Headers $headers `
        -Body $body `
        -ErrorAction SilentlyContinue

    Test-Failed "Fake price ID NOT rejected - CRITICAL VULNERABILITY"
    Add-Content -Path $ResultsFile -Value "Response: $($response | ConvertTo-Json)"
}
catch {
    $statusCode = $_.Exception.Response.StatusCode.value__
    $errorBody = $_.ErrorDetails.Message

    Add-Content -Path $ResultsFile -Value "HTTP Code: $statusCode"
    Add-Content -Path $ResultsFile -Value "Response: $errorBody"

    if ($statusCode -eq 400 -or $errorBody -match "invalid.*price") {
        Test-Passed "Fake price ID correctly rejected"
    } else {
        Test-Warning "Response unclear: HTTP $statusCode"
    }
}

###############################################################################
# TEST 7: Promo Status Endpoint
###############################################################################

Run-Test "Promo Status - Server-Side Validation"

try {
    $response = Invoke-RestMethod -Uri "$AppUrl/api/promo-status"
    Add-Content -Path $ResultsFile -Value "Promo Response: $($response | ConvertTo-Json)"

    if ($null -ne $response.active) {
        Test-Passed "Promo status endpoint returns valid response (active: $($response.active))"
        Test-Info "Server-side promo validation implemented (PENTEST-003 fix verified)"
    } else {
        Test-Failed "Promo status endpoint not working properly"
    }
}
catch {
    Test-Failed "Promo status endpoint failed: $_"
}

###############################################################################
# TEST 8: Rate Limiting
###############################################################################

Run-Test "Rate Limiting - Rapid Requests Test"

Test-Info "Sending 15 rapid requests to test rate limiting..."

$rateLimitTriggered = $false
for ($i = 1; $i -le 15; $i++) {
    try {
        $headers = @{
            "Authorization" = "Bearer $JwtToken"
        }

        $response = Invoke-WebRequest -Uri "$AppUrl/api/csrf-token" `
            -Headers $headers `
            -UseBasicParsing `
            -ErrorAction SilentlyContinue

        Start-Sleep -Milliseconds 100
    }
    catch {
        $statusCode = $_.Exception.Response.StatusCode.value__

        if ($statusCode -eq 429) {
            Test-Passed "Rate limiting triggered after $i requests (HTTP 429)"
            $rateLimitTriggered = $true
            break
        }
    }
}

if (-not $rateLimitTriggered) {
    Test-Warning "Rate limiting NOT triggered after 15 requests - may be vulnerable to abuse"
    Test-Warning "NOTE: Rate limiting may have higher threshold or be disabled in test env"
}

###############################################################################
# TEST 9: Error Handling
###############################################################################

Run-Test "Error Handling - Stack Trace Leakage"

try {
    $headers = @{
        "Authorization" = "Bearer $JwtToken"
        "Content-Type" = "application/json"
    }

    # Send malformed JSON to trigger error
    $response = Invoke-WebRequest -Uri "$AppUrl/api/stripe/create-checkout-session" `
        -Method Post `
        -Headers $headers `
        -Body "invalid json syntax" `
        -UseBasicParsing `
        -ErrorAction SilentlyContinue
}
catch {
    $errorResponse = $_.ErrorDetails.Message
    Add-Content -Path $ResultsFile -Value "Error Response: $errorResponse"

    if ($errorResponse -match "stack|\.js:|Error:\s*at|node_modules") {
        Test-Failed "STACK TRACE LEAKED in error response - information disclosure vulnerability"
    } else {
        Test-Passed "No stack trace in error response"
    }

    if ($errorResponse -match "supabase.*error|database.*error|pg_") {
        Test-Failed "DATABASE ERROR details leaked - schema information disclosure"
    } else {
        Test-Passed "No database error details in response"
    }
}

###############################################################################
# TEST 10: Webhook Signature Validation
###############################################################################

Run-Test "Webhook - Invalid Signature Rejection"

try {
    $headers = @{
        "Content-Type" = "application/json"
        "stripe-signature" = "fake_signature_12345"
    }

    $body = @{
        type = "checkout.session.completed"
        data = @{}
    } | ConvertTo-Json

    $response = Invoke-WebRequest -Uri "$AppUrl/api/stripe/webhook" `
        -Method Post `
        -Headers $headers `
        -Body $body `
        -UseBasicParsing `
        -ErrorAction SilentlyContinue

    Test-Failed "Invalid webhook signature NOT rejected - webhook vulnerable"
}
catch {
    $statusCode = $_.Exception.Response.StatusCode.value__
    $errorBody = $_.ErrorDetails.Message

    Add-Content -Path $ResultsFile -Value "HTTP Code: $statusCode"
    Add-Content -Path $ResultsFile -Value "Response: $errorBody"

    if ($statusCode -eq 400 -or $errorBody -match "signature") {
        Test-Passed "Invalid webhook signature correctly rejected"
    } else {
        Test-Warning "Response unclear: HTTP $statusCode"
    }
}

###############################################################################
# Summary
###############################################################################

Write-Host "`n========================================" -ForegroundColor Blue
Write-Host "  PENETRATION TEST COMPLETED" -ForegroundColor Blue
Write-Host "========================================`n" -ForegroundColor Blue

$content = Get-Content $ResultsFile -Raw
$passCount = ([regex]::Matches($content, "✅ PASS")).Count
$failCount = ([regex]::Matches($content, "❌ FAIL")).Count
$warnCount = ([regex]::Matches($content, "⚠️  WARNING")).Count

$summary = @"

RESULTS SUMMARY:
  ✅ Passed: $passCount
  ❌ Failed: $failCount
  ⚠️  Warnings: $warnCount

"@

Write-Host $summary
Add-Content -Path $ResultsFile -Value $summary

if ($failCount -gt 0) {
    Write-Host "RECOMMENDATION: DO NOT LAUNCH - Critical vulnerabilities found" -ForegroundColor Red
    Add-Content -Path $ResultsFile -Value "RECOMMENDATION: DO NOT LAUNCH - Critical vulnerabilities found"
    exit 1
}
elseif ($warnCount -gt 3) {
    Write-Host "RECOMMENDATION: CONDITIONAL LAUNCH - Review warnings" -ForegroundColor Yellow
    Add-Content -Path $ResultsFile -Value "RECOMMENDATION: CONDITIONAL LAUNCH - Review warnings"
    exit 2
}
else {
    Write-Host "RECOMMENDATION: APPROVED - All critical tests passed" -ForegroundColor Green
    Add-Content -Path $ResultsFile -Value "RECOMMENDATION: APPROVED - All critical tests passed"
    exit 0
}

Write-Host "`nFull results saved to: $ResultsFile`n"
