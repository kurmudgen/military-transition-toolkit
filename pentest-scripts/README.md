# Penetration Testing Scripts
## Military Transition Application - Security Testing Tools

This directory contains automated and manual penetration testing tools for comprehensive pre-launch security validation.

---

## ðŸ“ Files Overview

| File | Purpose | Platform |
|------|---------|----------|
| `PENETRATION_TEST_MANUAL.md` | Comprehensive manual testing procedures | All |
| `run-api-tests.sh` | Automated API security tests | Linux/Mac/WSL |
| `Run-ApiTests.ps1` | Automated API security tests | Windows PowerShell |
| `README.md` | This file | All |

---

## ðŸš€ Quick Start

### Option 1: Automated Testing (Recommended)

**Linux/Mac/WSL:**
```bash
cd pentest-scripts
chmod +x run-api-tests.sh
./run-api-tests.sh https://your-app.vercel.app "YOUR_JWT_TOKEN"
```

**Windows PowerShell:**
```powershell
cd pentest-scripts
.\Run-ApiTests.ps1 -AppUrl "https://your-app.vercel.app" -JwtToken "YOUR_JWT_TOKEN"
```

### Option 2: Manual Testing (Comprehensive)

1. Open `PENETRATION_TEST_MANUAL.md`
2. Follow step-by-step procedures for each test phase
3. Document findings using provided templates

---

## ðŸ“‹ Prerequisites

### For Automated Scripts

**Linux/Mac/WSL:**
- bash 4.0+
- curl (usually pre-installed)
- jq (install: `sudo apt install jq` or `brew install jq`)

**Windows:**
- PowerShell 5.1+ (built into Windows 10/11)
- No additional installations needed

### For Manual Testing

- Valid Vercel deployment URL
- 2-3 test user accounts (dedicated for testing)
- Supabase dashboard access
- Stripe dashboard access (test mode)
- Browser with DevTools (Chrome/Firefox recommended)
- Optional: Postman or curl for API testing

---

## ðŸ”‘ Getting Your JWT Token

The automated scripts require a valid JWT token from an authenticated user. Here's how to get it:

### Method 1: Browser DevTools (Easiest)

1. Navigate to your deployed app: `https://your-app.vercel.app`
2. Log in with a test account
3. Open Browser DevTools (F12)
4. Go to **Console** tab
5. Run this command:
   ```javascript
   JSON.parse(localStorage.getItem('supabase.auth.token')).access_token
   ```
6. Copy the JWT token (long string starting with "eyJ...")

### Method 2: Network Tab

1. Navigate to your app and log in
2. Open DevTools â†’ **Network** tab
3. Look for any API request (e.g., to `/api/csrf-token`)
4. Click the request â†’ **Headers** tab
5. Find `Authorization: Bearer eyJ...`
6. Copy the token after "Bearer "

### Method 3: Application Tab

1. DevTools â†’ **Application** tab (Chrome) or **Storage** tab (Firefox)
2. Local Storage â†’ `https://your-app.vercel.app`
3. Find key: `supabase.auth.token`
4. Copy the `access_token` value from the JSON

**âš ï¸ Security Note:** JWT tokens expire after 1 hour. If tests fail with 401 errors, get a fresh token.

---

## ðŸ§ª Automated Testing - Detailed Guide

### What the Scripts Test

The automated scripts run **14 comprehensive tests** covering:

1. **Security Headers** - CSP, X-Frame-Options, HSTS, etc.
2. **HTTPS Enforcement** - HTTP to HTTPS redirect
3. **CSRF Token Endpoint** - Token generation and format
4. **Authentication - Missing Token** - Unauthorized access rejection
5. **Authentication - Invalid Token** - Token validation
6. **Price Manipulation** - Invalid price ID rejection
7. **CSRF Protection** - State-changing operations
8. **Promo Status** - Server-side promo validation (PENTEST-003 fix)
9. **Rate Limiting** - Rapid request throttling
10. **Error Handling** - Stack trace leakage prevention
11. **Webhook Security** - Signature validation
12. **SQL Injection** - Parameterized query verification
13. **CORS Configuration** - Cross-origin policy
14. **Information Disclosure** - Sensitive endpoint exposure

### Interpreting Results

**Exit Codes:**
- `0` - âœ… All tests passed, approved for launch
- `1` - âŒ Critical failures found, DO NOT LAUNCH
- `2` - âš ï¸ Warnings present, review before launch

**Result Files:**
- Location: `results/api-test-results-TIMESTAMP.txt`
- Format: Plain text with color-coded results
- Contains: Full HTTP responses, headers, and analysis

**Example Output:**
```
âœ… PASS: Content-Security-Policy header present
âŒ FAIL: Rate limiting NOT triggered - may be vulnerable
âš ï¸  WARNING: CSRF protection unclear (HTTP 404)
```

### Running Tests Against Different Environments

**Production:**
```bash
./run-api-tests.sh https://military-transition.vercel.app "PROD_JWT_TOKEN"
```

**Staging:**
```bash
./run-api-tests.sh https://staging.military-transition.vercel.app "STAGING_JWT_TOKEN"
```

**Local Development:**
```bash
./run-api-tests.sh http://localhost:5173 "LOCAL_JWT_TOKEN"
```

---

## ðŸ“– Manual Testing - Detailed Guide

The `PENETRATION_TEST_MANUAL.md` file contains **10 comprehensive phases** with step-by-step procedures for manual penetration testing.

### When to Use Manual Testing

Use manual testing when:
- Automated tests show warnings or failures
- You need to verify UI-level security (XSS, CSRF in forms)
- Testing requires multi-step user workflows
- You need screenshots/evidence for compliance
- Automated tests cannot cover the scenario (e.g., cross-user data access)

### Manual Test Phases

| Phase | Duration | Focus | Criticality |
|-------|----------|-------|-------------|
| 1. Authentication & Authorization | 30 min | Email verification, session timeout, JWT manipulation | ðŸ”´ CRITICAL |
| 2. Rate Limiting | 20 min | Brute force, API abuse, webhook DoS | ðŸ”´ CRITICAL |
| 3. CSRF Protection | 20 min | Missing tokens, CSRF attacks | ðŸ”´ CRITICAL |
| 4. Data Protection & RLS | 30 min | Cross-user access, RLS bypass, audit logs | ðŸ”´ CRITICAL |
| 5. Payment Security | 30 min | Price manipulation, promo validation, webhooks | ðŸ”´ CRITICAL |
| 6. Account Deletion (GDPR) | 20 min | Complete erasure, audit anonymization | ðŸ”´ CRITICAL |
| 7. Input Validation & XSS | 20 min | Stored XSS, length limits, HTML injection | ðŸŸ  HIGH |
| 8. Error Handling | 15 min | Stack traces, PHI leakage, info disclosure | ðŸŸ  HIGH |
| 9. Dependencies & Infrastructure | 15 min | npm audit, security headers, HTTPS | ðŸŸ¡ MEDIUM |
| 10. End-to-End Workflows | 30 min | Complete user journeys, edge cases | ðŸŸ¡ MEDIUM |

**Total Estimated Time:** 2-3 hours for comprehensive coverage

### Using the Manual Test Templates

Each test in the manual includes:

âœ… **Objective** - What vulnerability you're testing for
âœ… **Steps** - Exact commands and procedures
âœ… **Expected Result** - What should happen if secure
âœ… **Predicted Result** - What code audit suggests will happen
âœ… **Evidence Template** - How to document findings
âœ… **Severity Rating** - CRITICAL/HIGH/MEDIUM/LOW

**Example Test from Manual:**
```markdown
### TEST 1.1: Email Verification Bypass Attempt ðŸ”´ CRITICAL

**VULNERABILITY**: Email verification only enforced client-side

**Test Steps**:
1. Create account with unverified@example.com
2. Do NOT verify email
3. Copy JWT token from localStorage
4. Call API directly with unverified JWT

**EXPECTED RESULT**: âœ… Request rejected
**PREDICTED RESULT**: âŒ Request succeeds (vulnerability confirmed)

**Fix Required**: Add server-side email verification check
```

---

## ðŸŽ¯ Testing Strategy

### Before Launch (Required)

1. **Run Automated Tests** (15 minutes)
   - Quick validation of all API endpoints
   - Identifies obvious vulnerabilities
   - Generates compliance evidence

2. **Manual Critical Tests** (1 hour)
   - Phases 1-6 from manual (all CRITICAL)
   - Focus on GDPR, PHI protection, payments
   - Document with screenshots

3. **Fix Critical Issues** (varies)
   - All âŒ FAIL results must be fixed
   - Re-test after fixes
   - Document remediation

4. **Final Validation** (30 minutes)
   - Re-run automated tests
   - Verify all CRITICAL issues resolved
   - Sign off on launch readiness

### After Launch (Ongoing)

1. **Weekly Automated Scans**
   - Run scripts against production
   - Monitor for new vulnerabilities
   - Track security posture over time

2. **Monthly Manual Review**
   - Test new features
   - Verify previous fixes still working
   - Update test procedures

3. **Quarterly Penetration Test**
   - Full manual testing (all 10 phases)
   - Third-party security audit
   - Compliance verification

---

## ðŸš¨ Critical Vulnerabilities (Pre-Launch Findings)

Based on code audit, these vulnerabilities are **PREDICTED** to exist and should be verified:

### ðŸ”´ CRITICAL (Block Launch)

| ID | Vulnerability | Test | Predicted Status |
|----|---------------|------|------------------|
| PENTEST-001 | Email verification bypass | Manual 1.1 | âŒ VULNERABLE |
| PENTEST-002 | Session timeout bypass | Manual 1.2 | âŒ VULNERABLE |
| PENTEST-004 | Rate limiting fails open | Manual 2.1 | âŒ VULNERABLE |
| PENTEST-005 | CSRF tokens not used | Manual 3.1, 3.2 | âŒ VULNERABLE |
| PENTEST-006 | auth.users never deleted | Manual 6.1 | âŒ VULNERABLE |
| PENTEST-007 | Validation library unused | Manual 7.1, 7.2 | âŒ VULNERABLE |
| PENTEST-008 | Length limits unenforced | Manual 7.2 | âŒ VULNERABLE |

### ðŸŸ  HIGH (Fix Before GA)

| ID | Vulnerability | Test | Predicted Status |
|----|---------------|------|------------------|
| PENTEST-009 | Webhook rate limiting missing | Manual 2.3 | âŒ VULNERABLE |
| PENTEST-010 | CORS headers missing | Automated Test 13 | âŒ VULNERABLE |
| PENTEST-011 | console.error PHI leakage | Manual 8.2 | âš ï¸ REVIEW LOGS |
| PENTEST-012 | Webhook error leakage | Manual 8.1 | âŒ VULNERABLE |

**All automated tests will verify these findings against the live deployment.**

---

## ðŸ“Š Results Analysis

### Automated Test Results

**Interpretation Guide:**

```
âœ… Passed: X
âŒ Failed: Y
âš ï¸  Warnings: Z
```

**Launch Decision Matrix:**

| Failures | Warnings | Recommendation |
|----------|----------|----------------|
| 0 | 0-3 | âœ… **APPROVED** - Safe to launch |
| 0 | 4+ | âš ï¸ **CONDITIONAL** - Review warnings, consider fixes |
| 1-2 | Any | âŒ **CONDITIONAL** - Fix critical issues, re-test |
| 3+ | Any | âŒ **DO NOT LAUNCH** - Multiple critical vulnerabilities |

### Manual Test Results

Use the result template in `PENETRATION_TEST_MANUAL.md` for each test:

**Required Documentation:**
- Screenshots of vulnerability exploitation
- curl commands or browser requests
- Database state before/after
- Affected code files and line numbers
- Recommended fixes with code samples

**Evidence Storage:**
- Create `results/evidence/` directory
- Save screenshots as `TEST_ID_description.png`
- Save network captures as `TEST_ID.har`
- Reference in test result template

---

## ðŸ› ï¸ Troubleshooting

### Common Issues

**Issue: "401 Unauthorized" on all API tests**
- **Cause:** JWT token expired (1-hour lifetime)
- **Fix:** Get fresh token from browser localStorage

**Issue: "ECONNREFUSED" or connection errors**
- **Cause:** Vercel URL incorrect or app not deployed
- **Fix:** Verify URL in browser first, check Vercel dashboard

**Issue: "Rate limiting NOT triggered"**
- **Cause:** Rate limiting may have higher threshold or be disabled
- **Expected:** 10 requests/10 minutes for most endpoints
- **Fix:** Check Upstash Redis dashboard, verify rate limit config

**Issue: "No security headers found"**
- **Cause:** vercel.json not deployed or overridden
- **Fix:** Check Vercel dashboard â†’ Settings â†’ Headers

**Issue: PowerShell "execution policy" error**
- **Cause:** Windows blocks unsigned scripts by default
- **Fix:** Run `Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass`

### Getting Help

**For Script Issues:**
1. Check exit code (0=success, 1=critical fail, 2=warnings)
2. Review full results file in `results/` directory
3. Look for specific error messages in output
4. Verify prerequisites installed (curl, jq, PowerShell)

**For Test Failures:**
1. Determine if failure is expected (see "Predicted Status" above)
2. Review corresponding code audit report (Phases 1-8)
3. Check `PENETRATION_TEST_MANUAL.md` for remediation steps
4. Create GitHub issue with test ID and evidence

---

## ðŸ“ Compliance Documentation

These test results serve as evidence for:

### HIPAA Compliance
- **Â§ 164.312(a)(1)** - Access Control: Authentication tests
- **Â§ 164.312(a)(2)(iv)** - Encryption: HTTPS enforcement
- **Â§ 164.312(b)** - Audit Controls: Audit log tests
- **Â§ 164.312(c)(1)** - Integrity: Data protection tests
- **Â§ 164.312(d)** - Authentication: JWT validation tests

### GDPR Compliance
- **Article 17** - Right to Erasure: Account deletion tests
- **Article 25** - Data Protection by Design: Security controls
- **Article 30** - Records of Processing: Audit logging tests
- **Article 32** - Security of Processing: All security tests

### PCI-DSS Compliance (via Stripe)
- **Requirement 6.5** - Application Security: XSS, injection tests
- **Requirement 6.6** - Web Application Firewall: Rate limiting, CSRF
- **Requirement 8.3** - Multi-Factor Authentication: Session security
- **Requirement 10.2** - Audit Logging: Payment operation logs

**Save test results for auditor review.**

---

## ðŸ”„ Continuous Testing

### Integration with CI/CD

Add to `.github/workflows/security-tests.yml`:

```yaml
name: Security Penetration Tests

on:
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday

jobs:
  pentest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Get JWT Token
        id: auth
        run: |
          # Your auth logic here
          echo "::set-output name=token::$JWT_TOKEN"

      - name: Run Penetration Tests
        run: |
          cd pentest-scripts
          chmod +x run-api-tests.sh
          ./run-api-tests.sh ${{ secrets.VERCEL_URL }} ${{ steps.auth.outputs.token }}

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: pentest-results
          path: pentest-scripts/results/
```

### Scheduled Testing

**Daily (Automated):**
```bash
0 6 * * * /path/to/run-api-tests.sh https://your-app.vercel.app "$JWT_TOKEN" >> /var/log/pentest-daily.log 2>&1
```

**Weekly (Manual Review):**
- Review automated test results
- Run manual tests for new features
- Update test procedures as needed

---

## ðŸ“ž Emergency Response

### If Vulnerability Found in Production

**IMMEDIATE ACTIONS:**

1. **STOP** - Suspend testing if PHI breach possible
2. **DOCUMENT** - Screenshot, save evidence
3. **NOTIFY** - Alert security team immediately
4. **CONTAIN** - Disable affected feature if critical
5. **FIX** - Deploy patch ASAP
6. **VERIFY** - Re-run tests to confirm fix
7. **REPORT** - Follow breach notification procedures if PHI involved

### Breach Notification Triggers

Report to legal/compliance if test reveals:
- Actual PHI exposure (veteran medical data visible)
- Unauthorized database access confirmed
- Cross-user data access successful
- Payment data exposure (unlikely with Stripe)

**Contact:** [Insert security team contact]

---

## ðŸ“š Additional Resources

- **OWASP Testing Guide:** https://owasp.org/www-project-web-security-testing-guide/
- **Stripe Security Best Practices:** https://stripe.com/docs/security
- **Supabase Security:** https://supabase.com/docs/guides/platform/going-into-prod#security
- **HIPAA Security Rule:** https://www.hhs.gov/hipaa/for-professionals/security/
- **GDPR Article 17:** https://gdpr-info.eu/art-17-gdpr/

---

## âœ… Pre-Launch Checklist

Before going live, ensure:

- [ ] Automated API tests run with 0 failures
- [ ] All 6 CRITICAL manual tests passed (Phases 1-6)
- [ ] GDPR account deletion verified (auth.users deleted)
- [ ] PHI input validation implemented (validation.js used)
- [ ] Rate limiting tested and working
- [ ] CSRF protection verified on all state-changing operations
- [ ] Email verification enforced server-side
- [ ] Session timeout enforced server-side
- [ ] Stack traces hidden in production
- [ ] Security headers verified in Vercel deployment
- [ ] npm audit shows 0 critical vulnerabilities
- [ ] Test results documented and saved
- [ ] Launch decision signed off by security team

---

*Military Transition Application - Penetration Testing Suite v1.0*
*Last Updated: 2025-11-03*
*Veteran PHI Protection - Zero Tolerance for Vulnerabilities*
