name: Claude Agent

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  claude-comment:
    if: >
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      github.event.sender.login != 'github-actions[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--max-turns 15"

  claude-issue:
    if: >
      github.event_name == 'issues' &&
      github.event.label.name == 'claude'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Read the issue title and description below. Analyze the codebase,
            implement the fix or feature described, and open a PR with your changes.

            Follow the CLAUDE.md guidelines in this repo.
            Write clear commit messages.
            Include a summary of what you changed and why in the PR description.
            Run the build before finishing to catch errors.

            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            ${{ github.event.issue.body }}
          claude_args: "--max-turns 20"
